local addr = "ws://192.168.178.27:8080/connect/computer"

function connect()
    ws, err = http.websocket(addr)
    if not ws then
        print(err)
    end

    ws.send(textutils.serialiseJSON({
        label = os.getComputerLabel(),
        id = os.getComputerID(),
    }))

    while true do
        local message, isBinary = ws.receive()
        if not isBinary then
            print(message)
            t = textutils.unserialiseJSON(message)

            local f, err = loadstring(t.func)
            if not err then
                local result = f()
                local resultJson = textutils.serialiseJSON(result)

                print("done: " .. t.func)
                ws.send(resultJson)
            else
                print(err)
                ws.send(textutils.serialiseJSON({
                    err = err
                }))
            end
        end
    end
end

local backoff = 1
while not pcall(connect) do
    print("trying to reconnect")
    sleep(backoff)
end